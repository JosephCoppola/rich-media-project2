<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, 
      #map-canvas {width: 700px; height: 400px;  display: block; margin: 0.5em auto; padding: 0;}
      #wrapper{position: relative;}
      #Cood{color:#FFFFFF; background: rgba(0,0,0,0.5); width:25%; height: 35%; text-align: center; position: absolute; top: 250px; left: 500px; z-index: 99;}
      #flyCurrent{color:#FFFFFF; background: rgba(0,0,0,0.5); width:20%; text-align: center; position: absolute; top: 15px; left: 15px; z-index: 99;}
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5nE35GiOoXsEm_Ck0ezB35HScFVe9bTw">
    </script>
      <!-- Import jQuery -->
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript">
      var map = undefined;
      var infoWindow = undefined;
      var updateCounter = 0;
      var mapOptions = undefined;
      var markers = [];
      var trail= false;
      var issInfo = undefined;

      //Initialize the app by setting intial values for google maps, get people currently residing on the ISS, get the ISS first position and then begin update
      function initialize() {

        $('#passesList').fadeOut(0);

        //Intial options for setting up google map
        mapOptions = {
          center: { lat: 0, lng: 0},
          zoom: 2,
          mapTypeId: google.maps.MapTypeId.SATELLITE,
          disableDefaultUI: true
        };

        //Create a google map object
        map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

        //Grab first geolocation of ISS
        getPeopleInSpace();

        //Get intial position and add ISS Marker
        getISSPosition();

        update();
      }

      //Handles updating the ISS position on the map
      //Updates every ~6 seconds
      function update()
      {
        //requestAnimationFrame(this.update.bind(this));

        //Once 6 seconds has passed reset the counter and set the new postion on the map
        if(updateCounter == 360)
        {
          updateCounter = 0;
          getISSPosition();
        }

        //Increment counter
        updateCounter++;

        //console.log(updateCounter);
      }

      //Calls the Open Notify API to access the latitude and longitude of the ISS, update the UI position, and set a new marker on the map
      function getISSPosition()
      {
        $.getJSON('http://api.open-notify.org/iss-now.json?callback=?', function(data)
        {

          //if trail is not true
          removeMarkers();

          var latitude = data['iss_position']['latitude'];
          var longitude = data['iss_position']['longitude'];

          document.querySelector("#lat").innerHTML = "Latitude: " + latitude;
          document.querySelector("#long").innerHTML = "Longitude: " + longitude;
          $("#Cood").fadeIn(1000);

          var center = { lat: latitude, lng: longitude};

          map.setCenter(center);

          addMarker(latitude,longitude,"<div>" + "<h3>International Space Station</h3>" + issInfo + "</div>");
        });
      }

      function getLocation()
      {
        if(navigator.geolocation)
        {
          navigator.geolocation.getCurrentPosition(searchFlybyMe,geoError);
        }
      }

      function getPeopleInSpace()
      {
        $.getJSON('http://api.open-notify.org/astros.json?callback=?', function(data) {
          stringPeople(data);
        });
      }

      function stringPeople(data)
      {
        issInfo = "<ul>";

        for(var i = 0; i < data.people.length; i++)
        {
           issInfo += "<li>" + data.people[i].name + "</li>";
        }

        issInfo += "</ul>"
      }

      function searchFlybyMe(position)
      {
        $('#passesList').fadeOut(0);
        $('#passesList').empty();

        var url = 'http://api.open-notify.org/iss-pass.json?';

        url += 'lat=' + position.coords.latitude + '&lon=' + position.coords.longitude + '&alt=20&n=5&callback=?'; 

        $.getJSON(url,function(data)
        {
          $('#passesList').append('<p>Passes for Latitude: ' + position.coords.latitude + ' Longitude: ' + position.coords.longitude)

          data['response'].forEach(function (d)
          {
              var date = new Date(d['risetime'] * 1000);
              $('#passesList').append('<li>' + date.toString() + '</li>');
          });
        });

        $("#passesList").fadeIn(1000);
      }

      function geoError(error)
      {
        console.log(error);
      }

      function addMarker(latp,longp,title){
        var position = {lat: latp,lng:longp};
        var marker = new google.maps.Marker({position: position, map:map, icon: 'issSmall.png'});
        marker.setTitle(title);
        google.maps.event.addListener(marker,'click',function(e){
          //Set window a bit above the marker, then reset to prevent the info window from spawning 10 above each click
            this.position.A += 10;
            makeInfoWindow(this.position,this.title);
            this.position.A -= 10;
        });

        markers.push(marker);
      }

      function makeInfoWindow(position,msg){
        if(infoWindow) infoWindow.close();

        infoWindow = new google.maps.InfoWindow({
          map: map,
          position: position,
          content: "<b>" + msg + "</b>"
        });
      }

      function removeMarkers()
      {
        if(infoWindow) infoWindow.close();

        for(var i = 0; i< markers.length; i++)
        {
          markers[i].setMap(null);
        }

        markers = [];
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id ="wrapper">
      <div id="map-canvas"></div>
      <div id="Cood">
        <p>Current Position</p>
        <div id="lat"></div>
        <div id="long"></div>
      </div>
      <div id="flyCurrent">
        <button onclick="getLocation()" type="button" style="margin: 5px">Next Fly By Me</button>
      </div>
    </div>
    <div id="passesList"></div>
  </body>
</html>